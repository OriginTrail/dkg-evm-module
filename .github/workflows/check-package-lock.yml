name: Check Package Lock File

permissions:
  contents: read

concurrency:
  group: check-package-lock-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main # Run on push to main branch only
  pull_request:
    branches:
      - "**" # Run on PR to any branch

jobs:
  verify-package-lock:
    name: Verify package-lock.json exists
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history to compare changes

      - name: Check if package-lock.json exists
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "ERROR: package-lock.json file is missing from the repository"
            echo "This file is required to ensure consistent dependency versions across all environments"
            echo "Please ensure package-lock.json is committed with your changes"
            exit 1
          fi
          echo "SUCCESS: package-lock.json file is present"

      - name: Verify package-lock.json is not empty
        run: |
          if [ ! -s "package-lock.json" ]; then
            echo "ERROR: package-lock.json file exists but is empty"
            echo "Please run 'npm install' to regenerate the lock file"
            exit 1
          fi
          echo "SUCCESS: package-lock.json file is valid and not empty"

      - name: Check if package.json was modified (PR only)
        if: github.event_name == 'pull_request'
        id: check-changes
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          PACKAGE_JSON_CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -c '^package\.json$' || true)
          PACKAGE_LOCK_CHANGED=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | grep -c '^package-lock\.json$' || true)

          echo "package_json_changed=$PACKAGE_JSON_CHANGED" >> $GITHUB_OUTPUT
          echo "package_lock_changed=$PACKAGE_LOCK_CHANGED" >> $GITHUB_OUTPUT

          if [ "$PACKAGE_JSON_CHANGED" -gt 0 ]; then
            echo "INFO: package.json was modified in this PR"
          else
            echo "INFO: package.json was not modified in this PR"
          fi

          if [ "$PACKAGE_LOCK_CHANGED" -gt 0 ]; then
            echo "INFO: package-lock.json was modified in this PR"
          else
            echo "INFO: package-lock.json was not modified in this PR"
          fi

          # Check if dependency-related fields actually changed
          DEPS_CHANGED="0"
          if [ "$PACKAGE_JSON_CHANGED" -gt 0 ]; then
            DEP_FIELDS='{dependencies, devDependencies, peerDependencies, optionalDependencies, overrides}'
            BASE_DEPS=$(git show "$BASE_SHA:package.json" | jq -S "$DEP_FIELDS" 2>/dev/null || echo "{}")
            HEAD_DEPS=$(git show "$HEAD_SHA:package.json" | jq -S "$DEP_FIELDS" 2>/dev/null || echo "{}")
            if [ "$BASE_DEPS" != "$HEAD_DEPS" ]; then
              DEPS_CHANGED="1"
              echo "INFO: Dependency-related fields in package.json were modified"
            else
              echo "INFO: Only non-dependency fields in package.json were modified (e.g., scripts, description)"
            fi
          fi
          echo "deps_changed=$DEPS_CHANGED" >> $GITHUB_OUTPUT

      - name: Verify package-lock.json is updated when dependencies change
        if: github.event_name == 'pull_request' && steps.check-changes.outputs.deps_changed != '0' && steps.check-changes.outputs.package_lock_changed == '0'
        run: |
          echo "ERROR: Dependency fields in package.json were modified but package-lock.json was not updated"
          echo "Please run 'npm install' to update the lock file and commit the changes"
          exit 1

      - name: Setup Node.js
        if: github.event_name == 'push' || steps.check-changes.outputs.package_json_changed != '0' || steps.check-changes.outputs.package_lock_changed != '0'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Validate package-lock.json is valid and in sync
        if: github.event_name == 'push' || steps.check-changes.outputs.package_json_changed != '0' || steps.check-changes.outputs.package_lock_changed != '0'
        run: npm ci --dry-run --ignore-scripts
